<div class="sheet-editor-container">
  <!-- Left sidebar: Sheet list -->
  <div class="sidebar sheets-sidebar">
    <div class="sidebar-header">
      <h3>Sheets</h3>
      <div class="header-actions">
        <button mat-icon-button matTooltip="New Sheet" (click)="createNewSheet()">
          <mat-icon>add</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Create from Multiple Sheets" (click)="openConglomerateDialog()">
          <mat-icon>merge</mat-icon>
        </button>
      </div>
    </div>
    <div class="sheet-list">
      @for (sheet of sheets; track sheet.id) {
        <div
          class="sheet-item"
          [class.active]="currentSheet?.id === sheet.id"
          (click)="selectSheet(sheet)"
        >
          <mat-icon>description</mat-icon>
          <span class="sheet-name"
            >{{ sheet.name }}
            @if (sheet.code) {
              <span class="sheet-code">[{{ sheet.code }}]</span>
            }
          </span>
          <button
            mat-icon-button
            class="delete-btn"
            (click)="deleteSheet(sheet, $event)"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      }
      @if (sheets.length === 0) {
        <div class="empty-hint">
          <p>No sheets yet. Create one to start!</p>
        </div>
      }
    </div>
  </div>

  <!-- Main editor area -->
  <div class="editor-main">
    @if (currentSheet) {
      <!-- Toolbar -->
      <div class="editor-toolbar">
        <mat-form-field appearance="outline" class="sheet-name-field">
          <mat-label>Sheet Name</mat-label>
          <input
            matInput
            [(ngModel)]="currentSheet.name"
            (ngModelChange)="scheduleAutoSave()"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="sheet-code-field">
          <mat-label>Code</mat-label>
          <input
            matInput
            [(ngModel)]="currentSheet.code"
            (ngModelChange)="scheduleAutoSave()"
            maxlength="5"
            placeholder="TF"
          />
        </mat-form-field>

        <div class="toolbar-group">
          <mat-form-field appearance="outline" class="size-select">
            <mat-label>Mini Size</mat-label>
            <mat-select [(ngModel)]="currentMiniSize">
              @for (size of miniSizes; track size.value) {
                <mat-option [value]="size.value">{{ size.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        <div class="toolbar-actions">
          <button
            mat-icon-button
            matTooltip="Auto-arrange"
            (click)="autoArrange()"
          >
            <mat-icon>auto_fix_high</mat-icon>
          </button>
          <button mat-raised-button color="accent" (click)="openPrintPreview()">
            <mat-icon>print</mat-icon>
            Print Preview
          </button>
          @if (hasUnsavedChanges) {
            <span class="autosave-indicator">Saving...</span>
          }
        </div>
      </div>

      <!-- Canvas area -->
      <div class="canvas-container">
        <div class="canvas-scroll">
          <div
            #sheetCanvas
            class="sheet-canvas"
            [style.width.px]="settings.pageWidth * displayScale"
            [style.height.px]="settings.pageHeight * displayScale"
            (click)="deselectPlacement()"
            (dragover)="onSheetDragOver($event)"
            (drop)="onSheetDrop($event)"
          >
            <!-- Grid overlay -->
            @if (settings.showGrid && settings.gridSnap > 0) {
              <svg
                class="grid-overlay"
                [attr.width]="settings.pageWidth * displayScale"
                [attr.height]="settings.pageHeight * displayScale"
              >
                <defs>
                  <pattern
                    id="grid"
                    [attr.width]="settings.gridSnap * displayScale"
                    [attr.height]="settings.gridSnap * displayScale"
                    patternUnits="userSpaceOnUse"
                  >
                    <path
                      [attr.d]="
                        'M ' +
                        settings.gridSnap * displayScale +
                        ' 0 L 0 0 0 ' +
                        settings.gridSnap * displayScale
                      "
                      fill="none"
                      stroke="rgba(100,100,100,0.3)"
                      stroke-width="0.5"
                    />
                  </pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#grid)" />
              </svg>
            }

            <!-- Margin indicators -->
            <div
              class="margin-indicator top"
              [style.height.px]="settings.marginTop * displayScale"
            ></div>
            <div
              class="margin-indicator bottom"
              [style.height.px]="settings.marginBottom * displayScale"
            ></div>
            <div
              class="margin-indicator left"
              [style.width.px]="settings.marginLeft * displayScale"
            ></div>
            <div
              class="margin-indicator right"
              [style.width.px]="settings.marginRight * displayScale"
            ></div>

            <!-- Placements -->
            @for (placement of placements; track placement.id) {
              <div
                class="mini-placement-group"
                [class.selected]="selectedPlacementId === placement.id"
                [class.has-back]="
                  placement.backMode && placement.backMode !== 'none'
                "
                [style.left.px]="placement.x * displayScale"
                [style.top.px]="placement.y * displayScale"
                (mousedown)="onPlacementMouseDown($event, placement)"
                (click)="selectPlacement(placement, $event)"
              >
                <!-- Front side -->
                <div
                  class="mini-placement front"
                  [style.width.px]="placement.width * displayScale"
                  [style.height.px]="placement.height * displayScale"
                >
                  <img
                    [src]="getImageUrl(placement.miniId)"
                    [alt]="getMini(placement.miniId)?.name"
                    class="placement-image"
                    draggable="false"
                  />

                  @if (placement.text) {
                    <div
                      class="placement-text"
                      [class]="'text-' + (placement.textPosition || 'bottom')"
                      [style.fontSize.px]="
                        ((placement.textSize || 8) * displayScale) / 72
                      "
                    >
                      {{ getDisplayLabel(placement.text) }}
                    </div>
                  }
                </div>

                <!-- Back side (if enabled) -->
                @if (placement.backMode && placement.backMode !== "none") {
                  <div
                    class="mini-placement back"
                    [style.width.px]="placement.width * displayScale"
                    [style.height.px]="placement.height * displayScale"
                  >
                    <img
                      [src]="getBackSideImageUrl(placement)"
                      [alt]="getMini(placement.miniId)?.name + ' (back)'"
                      class="placement-image"
                      draggable="false"
                    />

                    @if (placement.text) {
                      <div
                        class="placement-text"
                        [class]="'text-' + (placement.textPosition || 'bottom')"
                        [style.fontSize.px]="
                          ((placement.textSize || 8) * displayScale) / 72
                        "
                      >
                        {{ getDisplayLabel(placement.text) }}
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>
    } @else {
      <div class="no-sheet-selected">
        <mat-icon>description</mat-icon>
        <p>
          Select a sheet from the list or create a new one to start editing.
        </p>
        <button mat-raised-button color="primary" (click)="createNewSheet()">
          <mat-icon>add</mat-icon>
          Create New Sheet
        </button>
      </div>
    }
  </div>

  <!-- Right sidebar: Mini library & Properties -->
  <div class="sidebar properties-sidebar">
    <!-- Add New Mini Section -->
    <div
      class="sidebar-section collapsible"
      [class.collapsed]="collapsedSections.addMini"
    >
      <div class="section-header" (click)="toggleSection('addMini')">
        <h4>Add New Mini</h4>
        <mat-icon>{{
          collapsedSections.addMini ? "expand_more" : "expand_less"
        }}</mat-icon>
      </div>
      @if (!collapsedSections.addMini) {
        <div class="section-content">
          <div class="library-actions">
            <button mat-stroked-button (click)="addNewMini()">
              <mat-icon>add_photo_alternate</mat-icon>
              Front
            </button>
            <button mat-stroked-button (click)="addNewMiniWithBack()">
              <mat-icon>flip</mat-icon>
              Front + Back
            </button>
          </div>

          <div
            class="drop-zone"
            (dragover)="onLibraryDragOver($event)"
            (dragleave)="onLibraryDragLeave($event)"
            (drop)="onLibraryDrop($event)"
            [class.drag-over]="isDraggingToLibrary"
            (paste)="onLibraryPaste($event)"
            tabindex="0"
          >
            <mat-icon>cloud_upload</mat-icon>
            <span>Drop or paste images</span>
          </div>
        </div>
      }
    </div>

    <!-- Mini Library Section -->
    <div
      class="sidebar-section collapsible"
      [class.collapsed]="collapsedSections.library"
    >
      <div class="section-header" (click)="toggleSection('library')">
        <h4>Mini Library</h4>
        <mat-icon>{{
          collapsedSections.library ? "expand_more" : "expand_less"
        }}</mat-icon>
      </div>
      @if (!collapsedSections.library) {
        <div class="section-content mini-library">
          <!-- Search -->
          <mat-form-field appearance="outline" class="full-width search-field">
            <mat-label>Search minis</mat-label>
            <input
              matInput
              [(ngModel)]="miniSearch"
              (ngModelChange)="filterMinis()"
              placeholder="Name or tags"
            />
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <!-- Mini grid -->
          <div class="mini-library-list">
            @for (mini of filteredMinis; track mini.id) {
              <div
                class="library-mini"
                draggable="true"
                (dragstart)="onMiniDragStart($event, mini)"
                (dragend)="onMiniDragEnd()"
              >
                <img [src]="getImageUrl(mini.id)" [alt]="mini.name" />
                <span class="mini-name">{{ mini.name }}</span>
                @if (mini.hasBackImage) {
                  <mat-icon
                    class="has-back-indicator"
                    matTooltip="Has back image"
                    >flip</mat-icon
                  >
                }
              </div>
            }
            @if (filteredMinis.length === 0 && minis.length > 0) {
              <div class="empty-hint">
                <p>No minis match "{{ miniSearch }}"</p>
              </div>
            }
            @if (minis.length === 0) {
              <div class="empty-hint">
                <p>No minis yet. Add some above!</p>
              </div>
            }
          </div>
        </div>
      }
    </div>

    <mat-divider></mat-divider>

    <!-- Placement Properties Section -->
    @if (getSelectedPlacement(); as placement) {
      <div
        class="sidebar-section collapsible"
        [class.collapsed]="collapsedSections.properties"
      >
        <div class="section-header" (click)="toggleSection('properties')">
          <h4>Selected Mini</h4>
          <mat-icon>{{
            collapsedSections.properties ? "expand_more" : "expand_less"
          }}</mat-icon>
        </div>
        @if (!collapsedSections.properties) {
          <div class="section-content placement-properties compact">
            <div class="info-row">
              <span class="label">Name</span>
              <span class="value">{{ getMini(placement.miniId)?.name }}</span>
            </div>

            @if (getOriginalSize(placement.miniId); as size) {
              <div class="info-row">
                <span class="label">Original</span>
                <span class="value"
                  >{{ size.width }}" × {{ size.height }}"</span
                >
              </div>
            }

            <div class="inline-fields">
              <mat-form-field appearance="outline" class="compact-field">
                <mat-label>W</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="placement.width"
                  min="0.25"
                  max="8"
                  step="0.125"
                  (ngModelChange)="scheduleAutoSave()"
                />
              </mat-form-field>
              <span class="unit">×</span>
              <mat-form-field appearance="outline" class="compact-field">
                <mat-label>H</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="placement.height"
                  min="0.25"
                  max="10"
                  step="0.125"
                  (ngModelChange)="scheduleAutoSave()"
                />
              </mat-form-field>
              <span class="unit">in</span>
              <button
                mat-icon-button
                class="mini-btn"
                matTooltip='Reset (0.75")'
                (click)="resetPlacementSize(placement)"
              >
                <mat-icon>restart_alt</mat-icon>
              </button>
            </div>

            <mat-form-field appearance="outline" class="compact-select">
              <mat-label>Back</mat-label>
              <mat-select
                [(ngModel)]="placement.backMode"
                (ngModelChange)="scheduleAutoSave()"
              >
                <mat-option value="none">Front Only</mat-option>
                <mat-option
                  value="back-image"
                  [disabled]="!getMini(placement.miniId)?.hasBackImage"
                >
                  Use Back Image
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="compact-select">
              <mat-label>Label</mat-label>
              <input
                matInput
                [(ngModel)]="placement.text"
                (ngModelChange)="scheduleAutoSave()"
                placeholder="Optional"
              />
            </mat-form-field>

            @if (placement.text) {
              <div class="inline-fields">
                <mat-form-field
                  appearance="outline"
                  class="compact-field flex-1"
                >
                  <mat-label>Pos</mat-label>
                  <mat-select
                    [(ngModel)]="placement.textPosition"
                    (ngModelChange)="scheduleAutoSave()"
                  >
                    <mat-option value="top">Top</mat-option>
                    <mat-option value="center">Center</mat-option>
                    <mat-option value="bottom">Bottom</mat-option>
                  </mat-select>
                </mat-form-field>
                <mat-form-field appearance="outline" class="compact-field">
                  <mat-label>Size</mat-label>
                  <mat-select
                    [(ngModel)]="placement.textSize"
                    (ngModelChange)="scheduleAutoSave()"
                  >
                    <mat-option [value]="6">6</mat-option>
                    <mat-option [value]="8">8</mat-option>
                    <mat-option [value]="10">10</mat-option>
                    <mat-option [value]="12">12</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            }

            <div class="action-row">
              <button
                mat-icon-button
                matTooltip="Duplicate"
                (click)="duplicatePlacement(placement)"
              >
                <mat-icon>content_copy</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                matTooltip="Delete"
                (click)="deleteSelectedPlacement()"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        }
      </div>

      <mat-divider></mat-divider>
    }

    <!-- Sheet Settings Section -->
    @if (currentSheet) {
      <div
        class="sidebar-section collapsible"
        [class.collapsed]="collapsedSections.settings"
      >
        <div class="section-header" (click)="toggleSection('settings')">
          <h4>Sheet Settings</h4>
          <mat-icon>{{
            collapsedSections.settings ? "expand_more" : "expand_less"
          }}</mat-icon>
        </div>
        @if (!collapsedSections.settings) {
          <div class="section-content sheet-settings compact">
            <div class="info-row">
              <mat-icon class="small-icon">description</mat-icon>
              <span>US Letter (8.5" × 11")</span>
            </div>

            <div class="margins-grid">
              <mat-form-field appearance="outline" class="compact-field">
                <mat-label>T</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="settings.marginTop"
                  min="0"
                  max="2"
                  step="0.125"
                  (ngModelChange)="scheduleAutoSave()"
                />
              </mat-form-field>
              <mat-form-field appearance="outline" class="compact-field">
                <mat-label>B</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="settings.marginBottom"
                  min="0"
                  max="2"
                  step="0.125"
                  (ngModelChange)="scheduleAutoSave()"
                />
              </mat-form-field>
              <mat-form-field appearance="outline" class="compact-field">
                <mat-label>L</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="settings.marginLeft"
                  min="0"
                  max="2"
                  step="0.125"
                  (ngModelChange)="scheduleAutoSave()"
                />
              </mat-form-field>
              <mat-form-field appearance="outline" class="compact-field">
                <mat-label>R</mat-label>
                <input
                  matInput
                  type="number"
                  [(ngModel)]="settings.marginRight"
                  min="0"
                  max="2"
                  step="0.125"
                  (ngModelChange)="scheduleAutoSave()"
                />
              </mat-form-field>
            </div>

            <div class="inline-fields">
              <mat-form-field appearance="outline" class="compact-field flex-1">
                <mat-label>Grid</mat-label>
                <mat-select
                  [(ngModel)]="settings.gridSnap"
                  (ngModelChange)="scheduleAutoSave()"
                >
                  <mat-option [value]="0">Off</mat-option>
                  <mat-option [value]="0.125">⅛"</mat-option>
                  <mat-option [value]="0.25">¼"</mat-option>
                  <mat-option [value]="0.5">½"</mat-option>
                  <mat-option [value]="1">1"</mat-option>
                </mat-select>
              </mat-form-field>
              <mat-slide-toggle
                [(ngModel)]="settings.showGrid"
                (ngModelChange)="scheduleAutoSave()"
              >
                Show
              </mat-slide-toggle>
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>

<!-- Hidden file input for image uploads -->
<input
  type="file"
  #frontImageInput
  hidden
  accept="image/*"
  (change)="onFrontImageSelected($event)"
/>
<input
  type="file"
  #backImageInput
  hidden
  accept="image/*"
  (change)="onBackImageSelected($event)"
/>
