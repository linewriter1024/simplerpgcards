<div class="view-container">
  <!-- Left Sidebar -->
  <div class="sidebar">
    <!-- Compact Toolbar Layout (visible on small screens) -->
    <div class="toolbar-layout">
      <!-- Row 1: Title, Mode Switcher, Search -->
      <div class="toolbar-row">
        <span class="toolbar-title">Statblocks ({{ filteredStatblocks.length }})</span>
        
        <div class="mode-buttons">
          <button mat-stroked-button color="primary" (click)="switchToEditMode()" class="mode-button">
            <mat-icon>edit</mat-icon>
            Edit
          </button>
          <button mat-stroked-button color="accent" class="mode-button current-mode">
            <mat-icon>visibility</mat-icon>
            View
          </button>
        </div>
        
        <mat-form-field appearance="outline" class="toolbar-search">
          <mat-icon matPrefix>search</mat-icon>
          <input matInput [formControl]="searchControl" placeholder="Search...">
          @if (searchControl.value?.trim()) {
            <button mat-icon-button matSuffix (click)="clearFilters()">
              <mat-icon>close</mat-icon>
            </button>
          }
        </mat-form-field>
      </div>
      
      <!-- Row 2: Active Controls -->
      <div class="toolbar-row">
        <div class="active-section">
          <mat-icon class="section-icon">star</mat-icon>
          <span class="section-label">Active ({{ getActiveStatblocksCount() }})</span>
          <mat-slide-toggle 
            [(ngModel)]="showActiveOnly" 
            (change)="toggleActiveOnly()"
            class="toolbar-toggle">
            Show only
          </mat-slide-toggle>
          <button mat-stroked-button 
                  size="small"
                  color="primary" 
                  (click)="addActiveToSelected()" 
                  [disabled]="selection.selected.length === 0" 
                  class="toolbar-btn">
            <mat-icon>star</mat-icon>
            Mark Active
          </button>
          <button mat-stroked-button 
                  size="small"
                  color="accent" 
                  (click)="removeActiveFromSelected()" 
                  [disabled]="selection.selected.length === 0" 
                  class="toolbar-btn">
            <mat-icon>star_border</mat-icon>
            Remove
          </button>
        </div>
      </div>
      
      <!-- Row 3: Context Tag Controls -->
      <div class="toolbar-row">
        <div class="context-section">
          <mat-icon class="section-icon">label</mat-icon>
          <span class="section-label">{{ contextTag }} ({{ getContextStatblocksCount() }})</span>
          
          <!-- Context Tag Selector -->
          <mat-form-field appearance="outline" class="toolbar-context-field">
            <mat-label>Context Tag</mat-label>
            <input matInput [(ngModel)]="contextTag" (blur)="setContextTag(contextTag)" placeholder="campaign">
          </mat-form-field>
          
          <mat-slide-toggle 
            [(ngModel)]="showContextOnly" 
            (change)="toggleContextOnly()"
            class="toolbar-toggle">
            Show only
          </mat-slide-toggle>
          
          <button mat-stroked-button 
                  size="small"
                  color="primary" 
                  (click)="addContextToSelected()" 
                  [disabled]="selection.selected.length === 0 || !contextTag.trim()" 
                  class="toolbar-btn">
            <mat-icon>add</mat-icon>
            Add {{ contextTag }}
          </button>
          <button mat-stroked-button 
                  size="small"
                  color="accent" 
                  (click)="removeContextFromSelected()" 
                  [disabled]="selection.selected.length === 0 || !contextTag.trim()" 
                  class="toolbar-btn">
            <mat-icon>remove</mat-icon>
            Remove {{ contextTag }}
          </button>
        </div>
      </div>
      
      <!-- Row 4: Tags, Selection and Bulk Actions -->
      <div class="toolbar-row">
        @if (allTags.length > 0) {
          <div class="tag-chips">
            <mat-chip-listbox>
              @for (tag of allTags; track tag) {
                <mat-chip-option
                  [selected]="isTagHighlighted(tag)"
                  (click)="toggleTagFilter(tag)"
                  [class.highlighted-tag]="isTagHighlighted(tag)"
                  class="tag-chip">
                  {{ tag }}
                </mat-chip-option>
              }
            </mat-chip-listbox>
          </div>
        }
        
        <mat-checkbox (change)="$event ? toggleAllRows() : null"
                      [checked]="isAllSelected()"
                      [indeterminate]="isIndeterminate()"
                      class="toolbar-checkbox">
          Select All ({{ selection.selected.length }})
        </mat-checkbox>
        
        <button mat-stroked-button 
                size="small"
                color="accent" 
                (click)="clearSelection()" 
                [disabled]="selection.selected.length === 0" 
                class="toolbar-btn">
          <mat-icon>clear</mat-icon>
          Clear Selection
        </button>
      </div>
      
      <!-- Row 5: Bulk Tag Actions -->
      <div class="toolbar-row">
        <mat-form-field appearance="outline" class="toolbar-search">
          <input matInput [(ngModel)]="bulkTagInput" placeholder="Tag name">
          @if (bulkTagInput.trim()) {
            <button mat-icon-button matSuffix (click)="bulkTagInput = ''">
              <mat-icon>close</mat-icon>
            </button>
          }
        </mat-form-field>
        
        <button mat-stroked-button 
                size="small"
                color="primary" 
                (click)="addTagToSelected()" 
                [disabled]="!bulkTagInput.trim() || selection.selected.length === 0" 
                class="toolbar-btn">
          <mat-icon>add</mat-icon>
          Add Tag
        </button>
        
        <button mat-stroked-button 
                size="small"
                color="accent" 
                (click)="removeTagFromSelected()" 
                [disabled]="!bulkTagInput.trim() || selection.selected.length === 0" 
                class="toolbar-btn">
          <mat-icon>remove</mat-icon>
          Remove Tag
        </button>

        @if (allTags.length > 0) {
          <div class="quick-tags-toolbar">
            @for (tag of allTags; track tag) {
              <button type="button" class="quick-tag-btn" (click)="bulkTagInput = tag">{{ tag }}</button>
            }
          </div>
        }
      </div>
    </div>

    <!-- Sidebar Layout (visible on large screens) -->
    <div class="sidebar-layout">
      <div class="sidebar-content">
        <!-- Compact Header -->
        <div class="sidebar-header">
          <mat-icon class="sidebar-icon">view_list</mat-icon>
          <span class="sidebar-title">Statblocks</span>
          <span class="statblock-count">{{ filteredStatblocks.length }}</span>
        </div>
        
        <!-- Mode Switcher - Compact -->
        <div class="mode-switcher">
          <button mat-stroked-button 
                  color="primary"
                  (click)="switchToEditMode()"
                  class="mode-btn">
            <mat-icon>edit</mat-icon>
            Edit
          </button>
          
          <button mat-stroked-button 
                  color="accent"
                  class="mode-btn active">
            <mat-icon>visibility</mat-icon>
            View
          </button>
        </div>
        
        <!-- Search with clear button -->
        <div class="search-section">
          <mat-form-field appearance="outline" class="search-field">
            <mat-icon matPrefix>search</mat-icon>
            <input matInput [formControl]="searchControl" placeholder="Search...">
            @if (searchControl.value?.trim()) {
              <button mat-icon-button matSuffix (click)="clearFilters()">
                <mat-icon>close</mat-icon>
              </button>
            }
          </mat-form-field>
        </div>
        
        <!-- Active Controls Section -->
        <div class="control-section">
          <div class="section-header">
            <mat-icon class="section-icon">star</mat-icon>
            <span>Active ({{ getActiveStatblocksCount() }})</span>
          </div>
          
          <mat-slide-toggle 
            [(ngModel)]="showActiveOnly" 
            (change)="toggleActiveOnly()"
            class="compact-toggle">
            Show only active
          </mat-slide-toggle>
          
          <div class="button-row">
            <button mat-stroked-button 
                    size="small"
                    color="primary" 
                    (click)="addActiveToSelected()" 
                    [disabled]="selection.selected.length === 0" 
                    class="action-btn">
              <mat-icon>star</mat-icon>
              Mark Active
            </button>
            
            <button mat-stroked-button 
                    size="small"
                    color="accent" 
                    (click)="removeActiveFromSelected()" 
                    [disabled]="selection.selected.length === 0" 
                    class="action-btn">
              <mat-icon>star_border</mat-icon>
              Remove
            </button>
          </div>
        </div>
        
        <!-- Context Tag Controls Section -->
        <div class="control-section">
          <div class="section-header">
            <mat-icon class="section-icon">label</mat-icon>
            <span>{{ contextTag }} ({{ getContextStatblocksCount() }})</span>
          </div>
          
          <!-- Context Tag Selector -->
          <mat-form-field appearance="outline" class="context-field">
            <mat-label>Context Tag</mat-label>
            <input matInput [(ngModel)]="contextTag" (blur)="setContextTag(contextTag)" placeholder="campaign">
          </mat-form-field>
          
          <mat-slide-toggle 
            [(ngModel)]="showContextOnly" 
            (change)="toggleContextOnly()"
            class="compact-toggle">
            Show only {{ contextTag }}
          </mat-slide-toggle>
          
          <div class="button-row">
            <button mat-stroked-button 
                    size="small"
                    color="primary" 
                    (click)="addContextToSelected()" 
                    [disabled]="selection.selected.length === 0 || !contextTag.trim()" 
                    class="action-btn">
              <mat-icon>add</mat-icon>
              Add {{ contextTag }}
            </button>
            
            <button mat-stroked-button 
                    size="small"
                    color="accent" 
                    (click)="removeContextFromSelected()" 
                    [disabled]="selection.selected.length === 0 || !contextTag.trim()" 
                    class="action-btn">
              <mat-icon>remove</mat-icon>
              Remove {{ contextTag }}
            </button>
          </div>
        </div>
        
        <!-- Tags Section -->
        @if (allTags.length > 0) {
          <div class="control-section">
            <div class="section-header">
              <mat-icon class="section-icon">label</mat-icon>
              <span>Tags</span>
            </div>
            <div class="tags-container">
              <mat-chip-listbox class="compact-chips">
                @for (tag of allTags; track tag) {
                  <mat-chip-option
                    [selected]="isTagHighlighted(tag)"
                    (click)="toggleTagFilter(tag)"
                    [class.highlighted-tag]="isTagHighlighted(tag)"
                    class="compact-chip">
                    {{ tag }}
                  </mat-chip-option>
                }
              </mat-chip-listbox>
            </div>
          </div>
        }
        
        <!-- Selection Controls -->
        <div class="control-section">
          <div class="section-header">
            <mat-icon class="section-icon">checklist</mat-icon>
            <span>Selection ({{ selection.selected.length }})</span>
          </div>
          
          <div class="selection-controls">
            <mat-checkbox (change)="$event ? toggleAllRows() : null"
                         [checked]="isAllSelected()"
                         [indeterminate]="isIndeterminate()"
                         class="compact-checkbox">
              Select All
            </mat-checkbox>
            
            <button mat-stroked-button 
                    size="small"
                    color="accent" 
                    (click)="clearSelection()" 
                    [disabled]="selection.selected.length === 0" 
                    class="action-btn">
              <mat-icon>clear</mat-icon>
              Clear Selection
            </button>
          </div>
        </div>
        
        <!-- Bulk Actions -->
        <div class="control-section">
          <div class="section-header">
            <mat-icon class="section-icon">edit</mat-icon>
            <span>Bulk Tags</span>
          </div>
          
          <mat-form-field appearance="outline" class="bulk-field">
            <input matInput [(ngModel)]="bulkTagInput" placeholder="Tag name">
            @if (bulkTagInput.trim()) {
              <button mat-icon-button matSuffix (click)="bulkTagInput = ''">
                <mat-icon>close</mat-icon>
              </button>
            }
          </mat-form-field>
          
          <div class="button-row">
            <button mat-stroked-button 
                    size="small"
                    color="primary" 
                    (click)="addTagToSelected()" 
                    [disabled]="!bulkTagInput.trim() || selection.selected.length === 0" 
                    class="action-btn">
              <mat-icon>add</mat-icon>
              Add Tag
            </button>
            
            <button mat-stroked-button 
                    size="small"
                    color="accent" 
                    (click)="removeTagFromSelected()" 
                    [disabled]="!bulkTagInput.trim() || selection.selected.length === 0" 
                    class="action-btn">
              <mat-icon>remove</mat-icon>
              Remove Tag
            </button>
          </div>

          @if (allTags.length > 0) {
            <div class="quick-tags">
              @for (tag of allTags; track tag) {
                <button type="button" 
                        class="quick-tag-btn" 
                        (click)="bulkTagInput = tag">
                  {{ tag }}
                </button>
              }
            </div>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="statblocks-table" appDiceClick>
      @for (statblock of filteredStatblocks; track statblock.id) {
        <div class="statblock-row" 
             [class.selected]="selection.isSelected(statblock)"
             (click)="toggleRowSelection(statblock)">
          
          <!-- Row Actions -->
          <div class="row-actions">
            <mat-checkbox (change)="$event ? selection.toggle(statblock) : null"
                         [checked]="selection.isSelected(statblock)"
                         (click)="$event.stopPropagation()">
            </mat-checkbox>
            <button mat-icon-button color="primary" (click)="editStatblock(statblock); $event.stopPropagation()">
              <mat-icon>edit</mat-icon>
            </button>
            @if (statblock.hasImage && statblock.id && isStatblockEmpty(statblock)) {
              <button mat-icon-button [matMenuTriggerFor]="rowMenu" aria-label="Image options" (click)="$event.stopPropagation()">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #rowMenu="matMenu">
                <button mat-menu-item (click)="adjustSliceOffset(statblock, -8); $event.stopPropagation()">
                  <mat-icon>keyboard_arrow_up</mat-icon>
                  <span>Offset up</span>
                </button>
                <button mat-menu-item (click)="adjustSliceOffset(statblock, 8); $event.stopPropagation()">
                  <mat-icon>keyboard_arrow_down</mat-icon>
                  <span>Offset down</span>
                </button>
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="adjustImageScale(statblock, 'up'); $event.stopPropagation()">
                  <mat-icon>zoom_in</mat-icon>
                  <span>Image scale up</span>
                </button>
                <button mat-menu-item (click)="adjustImageScale(statblock, 'down'); $event.stopPropagation()">
                  <mat-icon>zoom_out</mat-icon>
                  <span>Image scale down</span>
                </button>
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="resetImageSettings(statblock); $event.stopPropagation()">
                  <mat-icon>restart_alt</mat-icon>
                  <span>Reset image settings</span>
                </button>
              </mat-menu>
            }
          </div>

          <!-- All Fields in Flex Layout -->
          <div class="row-content">
            <!-- Image-only presentation when other fields are empty -->
            @if (statblock.hasImage && statblock.id && isStatblockEmpty(statblock)) {
              <!-- Show sliced view when we have an image-only statblock -->
              <div class="image-sliced-row image-only-mode" (click)="openImage(statblock); $event.stopPropagation()">
                <!-- Name overlay for image-only statblocks -->
                @if (statblock.name && statblock.name.trim()) {
                  <div class="image-name-overlay">
                    <span class="image-name-text">{{ statblock.name }}</span>
                  </div>
                }
                
                <!-- Tags overlay for image-only statblocks -->
                @if (statblock.tags && statblock.tags.length > 0) {
                  <div class="image-tags-overlay">
                    @for (tag of statblock.tags; track tag) {
                      <span class="image-tag-chip">{{ tag }}</span>
                    }
                  </div>
                }
                
                <div #slicesContainer class="slices-scroll vertical-flow" [ngStyle]="getSlicesContainerStyle(statblock)" [attr.data-id]="statblock.id">
                  @if (getSlicesArray(statblock).length === 0) {
                    <img class="slice-fallback" [src]="statblockService.getImageUrl(statblock.id)" [alt]="statblock.name || 'Image'" />
                  } @else {
                    @for (i of getSlicesArray(statblock); track i) {
                      <div class="slice-tile" [ngStyle]="getSliceStyle(statblock, i)"></div>
                    }
                  }
                </div>
              </div>
            } @else {
              <!-- Regular statblock view with optional thumbnail -->
              @if (statblock.hasImage && statblock.id) {
                <div class="thumb-field" (click)="openImage(statblock); $event.stopPropagation()" title="Click to view image">
                  <img class="thumb" [src]="statblockService.getImageUrl(statblock.id)" alt="{{statblock.name}} thumbnail" />
                </div>
              }

              <!-- Basic Info Row -->
              <div class="basic-info-section">
                <div class="field name-field">
                  <div class="field-label">Name</div>
                  <div class="field-value">{{statblock.name}}</div>
                </div>

                @if (statblock.type) {
                  <div class="field type-field">
                    <div class="field-label">Type</div>
                    <div class="field-value">{{statblock.type}}</div>
                  </div>
                }

                <div class="field compact-field">
                  <div class="field-label">CR</div>
                  <div class="field-value">{{statblock.cr}}</div>
                </div>

                <div class="field compact-field">
                  <div class="field-label">EXP</div>
                  <div class="field-value">{{calculateExperience(statblock.cr)}}</div>
                </div>

                @if (statblock.hp) {
                  <div class="field compact-field">
                    <div class="field-label">HP</div>
                    <div class="field-value">{{formatHp(statblock.hp)}}</div>
                  </div>
                }

                <div class="field compact-field">
                  <div class="field-label">AC</div>
                  <div class="field-value">{{statblock.ac}}</div>
                </div>

                @if (statblock.spellSlots && statblock.spellSlots.length > 0) {
                  <div class="field spell-slots-field">
                    <div class="field-label">Spell Slots</div>
                    <div class="field-value spell-slots">{{formatSpellSlots(statblock.spellSlots)}}</div>
                  </div>
                }

                @if (statblock.tags && statblock.tags.length > 0) {
                  <div class="field text-field">
                    <div class="field-label">Tags</div>
                    <div class="field-value">
                      @for (tag of statblock.tags; track tag) {
                        <span class="tag-chip">{{tag}}</span>
                      }
                    </div>
                  </div>
                }

                <div class="abilities-group">
                  <div class="field ability-field">
                    <div class="field-label">STR</div>
                    <div class="field-value">{{statblock.str}} ({{getModifier(statblock.str)}})</div>
                  </div>
                  <div class="field ability-field">
                    <div class="field-label">DEX</div>
                    <div class="field-value">{{statblock.dex}} ({{getModifier(statblock.dex)}})</div>
                  </div>
                  <div class="field ability-field">
                    <div class="field-label">CON</div>
                    <div class="field-value">{{statblock.con}} ({{getModifier(statblock.con)}})</div>
                  </div>
                  <div class="field ability-field">
                    <div class="field-label">INT</div>
                    <div class="field-value">{{statblock.int}} ({{getModifier(statblock.int)}})</div>
                  </div>
                  <div class="field ability-field">
                    <div class="field-label">WIS</div>
                    <div class="field-value">{{statblock.wis}} ({{getModifier(statblock.wis)}})</div>
                  </div>
                  <div class="field ability-field">
                    <div class="field-label">CHA</div>
                    <div class="field-value">{{statblock.cha}} ({{getModifier(statblock.cha)}})</div>
                  </div>
                </div>
              </div>

              <!-- Text Fields Row -->
              <div class="text-fields-section">
                <div class="field attacks-field">
                  <div class="field-label">Attacks</div>
                  <div class="field-value text-content">
                    @if (statblock.attacks && statblock.attacks.length > 0) {
                      @for (attack of statblock.attacks; track attack.name) {
                        <span class="list-item" [innerHTML]="attack.name | diceLinkify"></span>
                      }
                    }
                  </div>
                </div>

                @if (statblock.spells && statblock.spells.length > 0) {
                  <div class="field spells-field-container">
                    <div class="field-label">Spells</div>
                    <div class="field-value text-content">
                      @for (spell of statblock.spells; track spell.name) {
                        <span class="list-item" [innerHTML]="(getSpellLevel(spell.name) ? (getSpellLevel(spell.name) + ' ' + getSpellText(spell.name)) : spell.name) | diceLinkify"></span>
                      }
                    </div>
                  </div>
                }

                @if (statblock.skills && statblock.skills.length > 0) {
                  <div class="field text-field">
                    <div class="field-label">Skills</div>
                    <div class="field-value text-content">
                      @for (skill of statblock.skills; track skill) {
                        <span class="list-item" [innerHTML]="skill | diceLinkify"></span>
                      }
                    </div>
                  </div>
                }

                @if (statblock.resistances && statblock.resistances.length > 0) {
                  <div class="field text-field">
                    <div class="field-label">Resistances</div>
                    <div class="field-value text-content">
                      @for (res of statblock.resistances; track res) {
                        <span class="list-item" [innerHTML]="res | diceLinkify"></span>
                      }
                    </div>
                  </div>
                }

                @if (statblock.notes && statblock.notes.trim()) {
                  <div class="field text-field">
                    <div class="field-label">Notes</div>
                    <div class="field-value text-content">
                      <span class="list-item" [innerHTML]="statblock.notes | diceLinkify"></span>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>
