<div class="view-container">
  <!-- Left Sidebar -->
  <div class="sidebar">
    <!-- Compact Toolbar Layout (visible on small screens) -->
    <div class="toolbar-layout">
      <!-- Row 1: Title, Mode Switcher, Search -->
      <div class="toolbar-row">
        <span class="toolbar-title">Statblocks</span>
        
        <div class="mode-buttons">
          <button mat-raised-button color="primary" (click)="switchToEditMode()" class="mode-button">
            <mat-icon>edit</mat-icon>
            Edit
          </button>
          <button mat-raised-button color="accent" class="mode-button current-mode">
            <mat-icon>view_list</mat-icon>
            View
          </button>
        </div>
        
        <mat-form-field appearance="outline" class="toolbar-search">
          <mat-label>Search</mat-label>
          <input matInput [formControl]="searchControl" placeholder="Search names and tags...">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        
        <button mat-button (click)="clearFilters()" class="toolbar-button">
          <mat-icon>clear</mat-icon>
        </button>
      </div>
      
      <!-- Row 2: Tags, Actions and Selection -->
      <div class="toolbar-row">
        @if (allTags.length > 0) {
          <div class="tag-chips">
            <mat-chip-listbox>
              @for (tag of allTags; track tag) {
                <mat-chip-option
                  [selected]="isTagHighlighted(tag)"
                  (click)="toggleTagFilter(tag)"
                  [class.highlighted-tag]="isTagHighlighted(tag)"
                  class="tag-chip">
                  {{ tag }}
                </mat-chip-option>
              }
            </mat-chip-listbox>
          </div>
        }
        
        <mat-checkbox (change)="$event ? toggleAllRows() : null"
                      [checked]="isAllSelected()"
                      [indeterminate]="isIndeterminate()"
                      class="toolbar-checkbox">
          Select All
        </mat-checkbox>
        
        <span class="toolbar-spacer"></span>
        <span class="statblock-count">{{ filteredStatblocks.length }} statblocks</span>
      </div>
      
      <!-- Row 3: Bulk Actions -->
      <div class="toolbar-row">
        <mat-form-field appearance="outline" class="toolbar-search">
          <mat-label>Tag for Bulk Action</mat-label>
          <input matInput [(ngModel)]="bulkTagInput" placeholder="Enter tag">
          @if (bulkTagInput.trim()) {
            <button mat-icon-button matSuffix aria-label="Clear bulk tag" (click)="bulkTagInput = ''">
              <mat-icon>clear</mat-icon>
            </button>
          }
        </mat-form-field>
        
        <button mat-raised-button color="primary" (click)="addTagToSelected()" 
                [disabled]="!bulkTagInput.trim() || selection.selected.length === 0" class="toolbar-button">
          <mat-icon>add</mat-icon>
          Add Tag
        </button>
        
        <button mat-raised-button color="accent" (click)="removeTagFromSelected()" 
                [disabled]="!bulkTagInput.trim() || selection.selected.length === 0" class="toolbar-button">
          <mat-icon>remove</mat-icon>
          Remove Tag
        </button>
      </div>

      <!-- Row 4: Bulk Tag Quick Pick -->
      @if (allTags.length > 0) {
        <div class="toolbar-row bulk-tags-row">
          <div class="bulk-tags-label">Quick pick existing tags:</div>
          <div class="bulk-tags-list">
            @for (tag of allTags; track tag) {
              <button type="button" class="bulk-tag-chip" (click)="bulkTagInput = tag">{{ tag }}</button>
            }
          </div>
        </div>
      }
    </div>

    <!-- Sidebar Layout (visible on large screens) -->
    <div class="sidebar-layout">
      <div class="sidebar-content">
        <h3>Statblocks</h3>
        
        <!-- Mode Switcher -->
        <div class="sidebar-section">
          <button mat-raised-button 
                  color="primary"
                  (click)="switchToEditMode()"
                  class="sidebar-button">
            <mat-icon>edit</mat-icon>
            Edit Mode
          </button>
          
          <button mat-raised-button 
                  color="accent"
                  class="sidebar-button">
            <mat-icon>view_list</mat-icon>
            View Mode (Current)
          </button>
        </div>
        
        <h4>Search & Filters</h4>
        
        <!-- Search -->
        <mat-form-field appearance="outline" class="sidebar-field">
          <mat-label>Search</mat-label>
          <input matInput [formControl]="searchControl" placeholder="Search names and tags...">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        
        <button mat-button (click)="clearFilters()" class="sidebar-button">Clear Filters</button>
        
        <!-- Active Controls Section -->
        <div class="sidebar-section">
          <h4>Active Statblocks</h4>
          <mat-slide-toggle 
            [(ngModel)]="showActiveOnly" 
            (change)="applyFilters()"
            class="sidebar-toggle">
            Show Active Only ({{ getActiveStatblocksCount() }})
          </mat-slide-toggle>
          
          <button mat-raised-button color="primary" (click)="addActiveToSelected()" 
                  [disabled]="selection.selected.length === 0" class="sidebar-button">
            <mat-icon>star</mat-icon>
            Mark Selected as Active
          </button>
          
          <button mat-raised-button color="accent" (click)="removeActiveFromSelected()" 
                  [disabled]="selection.selected.length === 0" class="sidebar-button">
            <mat-icon>star_border</mat-icon>
            Remove Active from Selected
          </button>
        </div>
        
        <!-- Tags Section -->
        @if (allTags.length > 0) {
          <div class="sidebar-section">
            <h4>Tags</h4>
            <div class="tags-grid">
              <mat-chip-listbox>
                @for (tag of allTags; track tag) {
                  <mat-chip-option
                    [selected]="isTagHighlighted(tag)"
                    (click)="toggleTagFilter(tag)"
                    [class.highlighted-tag]="isTagHighlighted(tag)">
                    {{ tag }}
                  </mat-chip-option>
                }
              </mat-chip-listbox>
            </div>
          </div>
        }
        
        <!-- Selection Controls -->
        <div class="sidebar-section">
          <h4>Selection</h4>
          <mat-checkbox (change)="$event ? toggleAllRows() : null"
                       [checked]="isAllSelected()"
                       [indeterminate]="isIndeterminate()"
                       class="sidebar-checkbox">
            Select All
          </mat-checkbox>
          
          <span class="statblock-count">{{ filteredStatblocks.length }} statblocks</span>
        </div>
        
        <!-- Bulk Actions -->
        <div class="sidebar-section">
          <h4>Bulk Actions</h4>
          <mat-form-field appearance="outline" class="sidebar-field">
            <mat-label>Tag for Bulk Action</mat-label>
            <input matInput [(ngModel)]="bulkTagInput" placeholder="Enter tag">
            @if (bulkTagInput.trim()) {
              <button mat-icon-button matSuffix aria-label="Clear bulk tag" (click)="bulkTagInput = ''">
                <mat-icon>clear</mat-icon>
              </button>
            }
          </mat-form-field>
          <button mat-raised-button color="primary" (click)="addTagToSelected()" 
                  [disabled]="!bulkTagInput.trim() || selection.selected.length === 0" class="sidebar-button">
            <mat-icon>add</mat-icon>
            Add Tag
          </button>
          <button mat-raised-button color="accent" (click)="removeTagFromSelected()" 
                  [disabled]="!bulkTagInput.trim() || selection.selected.length === 0" class="sidebar-button">
            <mat-icon>remove</mat-icon>
            Remove Tag
          </button>

          @if (allTags.length > 0) {
            <div class="bulk-tags">
              <div class="bulk-tags-label">Quick pick existing tags:</div>
              <div class="bulk-tags-list">
                @for (tag of allTags; track tag) {
                  <button type="button" class="bulk-tag-chip" (click)="bulkTagInput = tag">{{ tag }}</button>
                }
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="statblocks-table" appDiceClick>
      @for (statblock of filteredStatblocks; track statblock.id) {
        <div class="statblock-row" 
             [class.selected]="selection.isSelected(statblock)"
             (click)="toggleRowSelection(statblock)">
          
          <!-- Row Actions -->
          <div class="row-actions">
            <mat-checkbox (change)="$event ? selection.toggle(statblock) : null"
                         [checked]="selection.isSelected(statblock)"
                         (click)="$event.stopPropagation()">
            </mat-checkbox>
            <button mat-icon-button color="primary" (click)="editStatblock(statblock); $event.stopPropagation()">
              <mat-icon>edit</mat-icon>
            </button>
            @if (statblock.hasImage && statblock.id && isStatblockEmpty(statblock)) {
              <button mat-icon-button [matMenuTriggerFor]="rowMenu" aria-label="Image options" (click)="$event.stopPropagation()">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #rowMenu="matMenu">
                <button mat-menu-item (click)="adjustSliceOffset(statblock, -8); $event.stopPropagation()">
                  <mat-icon>keyboard_arrow_up</mat-icon>
                  <span>Offset up</span>
                </button>
                <button mat-menu-item (click)="adjustSliceOffset(statblock, 8); $event.stopPropagation()">
                  <mat-icon>keyboard_arrow_down</mat-icon>
                  <span>Offset down</span>
                </button>
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="adjustImageScale(statblock, 'up'); $event.stopPropagation()">
                  <mat-icon>zoom_in</mat-icon>
                  <span>Image scale up</span>
                </button>
                <button mat-menu-item (click)="adjustImageScale(statblock, 'down'); $event.stopPropagation()">
                  <mat-icon>zoom_out</mat-icon>
                  <span>Image scale down</span>
                </button>
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="resetImageSettings(statblock); $event.stopPropagation()">
                  <mat-icon>restart_alt</mat-icon>
                  <span>Reset image settings</span>
                </button>
              </mat-menu>
            }
          </div>

          <!-- All Fields in Flex Layout -->
          <div class="row-content">
            <!-- Image-only presentation when other fields are empty -->
            @if (statblock.hasImage && statblock.id && isStatblockEmpty(statblock)) {
              <!-- Show sliced view when we have an image-only statblock -->
              <div class="image-sliced-row image-only-mode" (click)="openImage(statblock); $event.stopPropagation()">
                <div #slicesContainer class="slices-scroll vertical-flow" [ngStyle]="getSlicesContainerStyle(statblock)" [attr.data-id]="statblock.id">
                  @if (getSlicesArray(statblock).length === 0) {
                    <img class="slice-fallback" [src]="statblockService.getImageUrl(statblock.id)" [alt]="statblock.name || 'Image'" />
                  } @else {
                    @for (i of getSlicesArray(statblock); track i) {
                      <div class="slice-tile" [ngStyle]="getSliceStyle(statblock, i)"></div>
                    }
                  }
                </div>
              </div>
            } @else {
              <!-- Regular statblock view with optional thumbnail -->
              @if (statblock.hasImage && statblock.id) {
                <div class="thumb-field" (click)="openImage(statblock); $event.stopPropagation()" title="Click to view image">
                  <img class="thumb" [src]="statblockService.getImageUrl(statblock.id)" alt="{{statblock.name}} thumbnail" />
                </div>
              }

              <!-- Basic Info Row -->
              <div class="basic-info-section">
                <div class="field name-field">
                  <div class="field-label">Name</div>
                  <div class="field-value">{{statblock.name}}</div>
                </div>

                @if (statblock.type) {
                  <div class="field type-field">
                    <div class="field-label">Type</div>
                    <div class="field-value">{{statblock.type}}</div>
                  </div>
                }

                <div class="field compact-field">
                  <div class="field-label">CR</div>
                  <div class="field-value">{{statblock.cr}}</div>
                </div>

                <div class="field compact-field">
                  <div class="field-label">EXP</div>
                  <div class="field-value">{{calculateExperience(statblock.cr)}}</div>
                </div>

                @if (statblock.hp) {
                  <div class="field compact-field">
                    <div class="field-label">HP</div>
                    <div class="field-value">{{formatHp(statblock.hp)}}</div>
                  </div>
                }

                <div class="field compact-field">
                  <div class="field-label">AC</div>
                  <div class="field-value">{{statblock.ac}}</div>
                </div>

                @if (statblock.spellSlots && statblock.spellSlots.length > 0) {
                  <div class="field spell-slots-field">
                    <div class="field-label">Spell Slots</div>
                    <div class="field-value spell-slots">{{formatSpellSlots(statblock.spellSlots)}}</div>
                  </div>
                }

                @if (statblock.tags && statblock.tags.length > 0) {
                  <div class="field text-field">
                    <div class="field-label">Tags</div>
                    <div class="field-value">
                      @for (tag of statblock.tags; track tag) {
                        <span class="tag-chip">{{tag}}</span>
                      }
                    </div>
                  </div>
                }

                <div class="abilities-group">
                  <div class="field ability-field">
                    <div class="field-label">STR</div>
                    <div class="field-value">{{statblock.str}} ({{getModifier(statblock.str)}})</div>
                  </div>
                  <div class="field ability-field">
                    <div class="field-label">DEX</div>
                    <div class="field-value">{{statblock.dex}} ({{getModifier(statblock.dex)}})</div>
                  </div>
                  <div class="field ability-field">
                    <div class="field-label">CON</div>
                    <div class="field-value">{{statblock.con}} ({{getModifier(statblock.con)}})</div>
                  </div>
                  <div class="field ability-field">
                    <div class="field-label">INT</div>
                    <div class="field-value">{{statblock.int}} ({{getModifier(statblock.int)}})</div>
                  </div>
                  <div class="field ability-field">
                    <div class="field-label">WIS</div>
                    <div class="field-value">{{statblock.wis}} ({{getModifier(statblock.wis)}})</div>
                  </div>
                  <div class="field ability-field">
                    <div class="field-label">CHA</div>
                    <div class="field-value">{{statblock.cha}} ({{getModifier(statblock.cha)}})</div>
                  </div>
                </div>
              </div>

              <!-- Text Fields Row -->
              <div class="text-fields-section">
                <div class="field attacks-field">
                  <div class="field-label">Attacks</div>
                  <div class="field-value text-content">
                    @if (statblock.attacks && statblock.attacks.length > 0) {
                      @for (attack of statblock.attacks; track attack.name) {
                        <span class="list-item" [innerHTML]="attack.name | diceLinkify"></span>
                      }
                    }
                  </div>
                </div>

                @if (statblock.spells && statblock.spells.length > 0) {
                  <div class="field spells-field-container">
                    <div class="field-label">Spells</div>
                    <div class="field-value text-content">
                      @for (spell of statblock.spells; track spell.name) {
                        <span class="list-item" [innerHTML]="(getSpellLevel(spell.name) ? (getSpellLevel(spell.name) + ' ' + getSpellText(spell.name)) : spell.name) | diceLinkify"></span>
                      }
                    </div>
                  </div>
                }

                @if (statblock.skills && statblock.skills.length > 0) {
                  <div class="field text-field">
                    <div class="field-label">Skills</div>
                    <div class="field-value text-content">
                      @for (skill of statblock.skills; track skill) {
                        <span class="list-item" [innerHTML]="skill | diceLinkify"></span>
                      }
                    </div>
                  </div>
                }

                @if (statblock.resistances && statblock.resistances.length > 0) {
                  <div class="field text-field">
                    <div class="field-label">Resistances</div>
                    <div class="field-value text-content">
                      @for (res of statblock.resistances; track res) {
                        <span class="list-item" [innerHTML]="res | diceLinkify"></span>
                      }
                    </div>
                  </div>
                }

                @if (statblock.notes && statblock.notes.trim()) {
                  <div class="field text-field">
                    <div class="field-label">Notes</div>
                    <div class="field-value text-content">
                      <span class="list-item" [innerHTML]="statblock.notes | diceLinkify"></span>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>
